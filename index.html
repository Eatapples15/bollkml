<!DOCTYPE html>
<html>
<head>
    <title>Colora Comuni Basilicata (Selezione Colori)</title>
    <script>
        let coloriComuni = {}; // Oggetto per memorizzare i colori dei comuni

        function coloraComuni() {
            // 1. Leggi il file KML
            fetch("basilicata.kml")
                .then(response => response.text())
                .then(kmlString => {
                    // 2. Analizza il file KML
                    const parser = new DOMParser();
                    const kml = parser.parseFromString(kmlString, "text/xml");

                    // 3. Itera sui Placemark (comuni) nel file KML
                    const placemarks = kml.querySelectorAll("Placemark");
                    placemarks.forEach(placemark => {
                        const comuneNome = placemark.querySelector("name").textContent;
                        const comuneStyle = placemark.querySelector("Style");

                        // 4. Applica il colore selezionato al comune
                        if (coloriComuni[comuneNome]) {
                            const colore = coloriComuni[comuneNome];
                            if (comuneStyle) {
                                // Se esiste già uno stile, modifica il colore
                                const polyStyle = comuneStyle.querySelector("PolyStyle");
                                if (polyStyle) {
                                    polyStyle.querySelector("color").textContent = coloreAColorKML(colore);
                                }
                            } else {
                                // Se non esiste uno stile, creane uno nuovo
                                const style = kml.createElement("Style");
                                const polyStyle = kml.createElement("PolyStyle");
                                const colorElement = kml.createElement("color");
                                colorElement.textContent = coloreAColorKML(colore);
                                polyStyle.appendChild(colorElement);
                                style.appendChild(polyStyle);
                                placemark.appendChild(style);
                            }
                        }
                    });

                    // 5. Aggiorna il file KML (opzionale)
                    const serializer = new XMLSerializer();
                    const updatedKmlString = serializer.serializeToString(kml);
                    console.log(updatedKmlString); // Puoi salvare questo output in un nuovo file KML
                });
        }

        // Funzione per convertire il colore in formato KML (AABBGGRR)
        function coloreAColorKML(colore) {
            const hex = {
                "red": "7fff0000",
                "green": "7f00ff00",
                "blue": "7f0000ff",
                "yellow": "7f00ffff",
                "orange": "7f00a5ff",
                "purple": "7f800080",
                "brown": "7fa52a2a",
                "pink": "7fffc0cb",
                "cyan": "7f00ffff",
                "magenta": "7fff00ff"
            };
            return hex[colore] || "7fffffff"; // Bianco se il colore non è definito
        }

        function aggiungiSelezioneColore(comuneNome) {
            const selezioneColore = document.createElement("div");
            selezioneColore.innerHTML = `<label for="${comuneNome}">Colore per ${comuneNome}:</label><input type="color" id="${comuneNome}" value="#ff0000"><button onclick="salvaColore('${comuneNome}')">Salva</button>`;
            document.getElementById("selezioniColori").appendChild(selezioneColore);
        }

        function salvaColore(comuneNome) {
            const colore = document.getElementById(comuneNome).value;
            coloriComuni[comuneNome] = colore;
        }

        function generaSelezioniColori() {
            // 1. Leggi il file KML
            fetch("basilicata.kml")
                .then(response => response.text())
                .then(kmlString => {
                    // 2. Analizza il file KML
                    const parser = new DOMParser();
                    const kml = parser.parseFromString(kmlString, "text/xml");

                    // 3. Itera sui Placemark (comuni) nel file KML
                    const placemarks = kml.querySelectorAll("Placemark");
                    placemarks.forEach(placemark => {
                        const comuneNome = placemark.querySelector("name").textContent;
                        aggiungiSelezioneColore(comuneNome);
                    });
                });
        }
    </script>
</head>
<body onload="generaSelezioniColori()">
    <h1>Colora Comuni Basilicata (Selezione Colori)</h1>
    <div id="selezioniColori"></div>
    <button onclick="coloraComuni()">Applica Colori</button>
</body>
</html>
